FROM golang:1.12-alpine as build

RUN apk update && apk add --no-cache git ca-certificates gcc musl-dev git fuse jq curl bash

# Build static gen3-fuse binary
RUN mkdir -p $GOPATH/src/github.com/uc-cdis/gen3-fuse
WORKDIR $GOPATH/src/github.com/uc-cdis/gen3-fuse
COPY . .
RUN go build -ldflags "-linkmode external -extldflags -static"

FROM alpine
RUN apk update && apk add --no-cache fuse jq curl bash
COPY --from=build /go/src/github.com/uc-cdis/gen3-fuse/gen3-fuse \
    /go/src/github.com/uc-cdis/gen3-fuse/sidecarDockerrun.sh \
    /go/src/github.com/uc-cdis/gen3-fuse/marinerRun.sh \
    /go/src/github.com/uc-cdis/gen3-fuse/config.yaml \
    /

ENV HOME=/
CMD [ "/bin/bash", "/sidecarDockerrun.sh"]
