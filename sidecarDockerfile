FROM golang:1.12-alpine

RUN apk update && apk add --no-cache git ca-certificates gcc musl-dev git fuse jq curl bash python3
RUN adduser jovyan -u 1000 -G users -D
RUN echo $GOPATH
RUN mkdir -p $GOPATH/src/github.com/uc-cdis/gen3-fuse
WORKDIR $GOPATH/src/github.com/uc-cdis/gen3-fuse
ADD . .
RUN go build -ldflags "-linkmode external -extldflags -static"
RUN mv config.yaml /home/jovyan/fuse-config.yaml
RUN cp sidecarDockerrun.sh /sidecarDockerrun.sh
RUN mv sidecarDockerrun.sh /home/jovyan/sidecarDockerrun.sh
RUN mv gen3-fuse /usr/local/bin/gen3-fuse
USER jovyan
CMD [ "/bin/sh", "/usr/local/gen3/sidecarDockerrun.sh"]
